name: EAS Build (PR labels)

on:
  pull_request:
    types: [labeled]

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
      skip: ${{ steps.set-matrix.outputs.skip }}
    steps:
      - name: Build matrix from PR labels
        id: set-matrix
        uses: actions/github-script@v7
        with:
          script: |
            const labels = (context.payload.pull_request.labels || []).map((label) => label.name);
            const builds = [];

            for (const label of labels) {
              if (!label.startsWith("eas-build")) {
                continue;
              }

              const [base, profilePart] = label.split(":");
              let platform = "all";
              if (base !== "eas-build") {
                const parts = base.split("-");
                platform = parts[2] || "all";
              }

              const profile = profilePart || "production";
              if (!["ios", "android", "all"].includes(platform)) {
                continue;
              }

              builds.push({ platform, profile });
            }

            const expanded = [];
            for (const build of builds) {
              const platforms = build.platform === "all" ? ["ios", "android"] : [build.platform];
              for (const platform of platforms) {
                expanded.push({ platform, profile: build.profile });
              }
            }

            const unique = [];
            const seen = new Set();
            for (const item of expanded) {
              const key = `${item.platform}:${item.profile}`;
              if (seen.has(key)) {
                continue;
              }
              seen.add(key);
              unique.push(item);
            }

            if (unique.length === 0) {
              core.notice("No eas-build label found on PR.");
              core.setOutput("skip", "true");
              core.setOutput("matrix", JSON.stringify({ include: [] }));
              return;
            }

            core.setOutput("skip", "false");
            core.setOutput("matrix", JSON.stringify({ include: unique }));

  build:
    needs: prepare
    if: needs.prepare.outputs.skip != 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.prepare.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 20
      - uses: expo/expo-github-action@v8
        with:
          eas-version: latest
          token: ${{ secrets.EXPO_TOKEN }}
      - name: EAS build
        working-directory: frontend
        run: eas build --platform ${{ matrix.platform }} --profile ${{ matrix.profile }} --non-interactive
