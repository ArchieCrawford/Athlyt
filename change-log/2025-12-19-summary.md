# Athlyt App Snapshot — 2025-12-19

## Updates through 2025-12-21
- Expo video migration: feed post player switched from `expo-av` `Video` to `expo-video` `VideoView`, with string `contentFit` to avoid runtime undefined enums.
- Camera screen hardening: safe flash mode fallbacks (no direct `FlashMode.*`), `Camera.Constants.Type` defaults, and permission calls pulled from `Camera.*` methods; image picker uses new `MediaType` array with fallback to `MediaTypeOptions`.
- Supabase storage/RLS: added bucket `media` and policies for per-user `profileImage/<uid>` uploads (public read), plus `ts-nocheck` on Deno edge functions to quiet editor type errors.
- App config: `app.json` slug aligned to EAS project (`frontend`) while keeping display name adjustable; bundle ids set to `com.archie.crawford1.frontend` (can be swapped to Tayp naming if desired).
- Dev build workflow: confirmed `npx eas build --profile development --platform ios` works after slug fix; start with `npx expo start --dev-client --port 8080 -c` for JS updates.
- UX polish: profile header restyled to a TikTok-like top icon row; change-password and settings/legal routes added to the stack; loading gate now shows the branded `assets/loadscreen.png` full-bleed background with overlayed spinner/text so the thumbnail fits the screen.


This document is a full handoff for another AI/engineer to recreate and continue the project. It includes structure, responsibilities per file, environment requirements, and run books.

## High-Level Overview
- Mobile app: Expo SDK 54 (React Native 0.81.5 / React 19.1), React Navigation, Redux Toolkit, React Query v5.
- Backend/data: Supabase (Postgres, Auth, Storage, Realtime). Firebase removed.
- Scraper: Node/Playwright scripts under `backend/Supabase` to ingest coach data into Supabase.
- Auth: Supabase email/password, persisted via AsyncStorage on native; profile rows in `user` table auto-created and subscribed to realtime changes via AuthProvider (Redux auth thunks now largely unused).

## Directory Tree (trimmed with roles)
```
Athlyt/
├─ backend/
│  ├─ Supabase/
│  │  ├─ package.json / package-lock.json   # Node + Playwright deps for scraper/ingest
│  │  ├─ schema.sql                         # Supabase schema (user, post, following, chat, etc.); now includes mux fields
│  │  ├─ scrape_all_to_supabase.mjs         # Main scraper orchestrator; scrapes coaches and upserts to Supabase
│  │  ├─ ingest.mjs                         # Helper ingest script (per-source)
│  │  ├─ collegecoaches-all/                # Source HTML/assets for scraping
│  │  ├─ supa-ingest/                       # Additional ingest helpers
│  │  ├─ logs/                              # Run logs (e.g., scrape_*.log)
│  │  └─ node_modules/                      # Installed deps
│  ├─ Supabase/supabase/functions/          # Supabase Edge Functions (Mux direct-upload + webhook)
│  ├─ functions/                            # (Legacy) Firebase functions scaffold; currently unused after Supabase migration
│  ├─ .env                                  # Backend env (not checked in)
│  ├─ firebase.json                         # Legacy Firebase config
│  └─ .firebaserc                           # Legacy Firebase project pointer
├─ frontend/
│  ├─ App.tsx                               # App root; wraps Redux, React Query v5, AuthProvider, and navigation Route
│  ├─ supabaseClient.ts                     # Supabase client (AsyncStorage auth persistence, URL/anon env)
│  ├─ src/
│  │  ├─ providers/
│  │  │  └─ AuthProvider.tsx                # Supabase auth/session manager; ensures profile row, subscribes realtime, syncs Redux/post preload
│  │  ├─ hooks/
│  │  │  ├─ useAuth.ts                      # Exposes AuthProvider context
│  │  │  ├─ useChats.ts, useMessages.ts     # Chat listeners/loaders using Supabase
│  │  │  ├─ useFollowing*.ts                # Follow state hooks
│  │  │  └─ queryKeys.ts                    # React Query keys
│  │  ├─ navigation/
│  │  │  ├─ main/index.tsx                  # Root stack; auth gate -> auth/home/profile/edit/chat routes
│  │  │  ├─ home/index.tsx                  # Bottom tabs: feed/search/camera/chat/profile
│  │  │  └─ feed/index.tsx                  # Top tabs for feed vs profile view
│  │  ├─ redux/
│  │  │  ├─ store.ts                        # Configures Redux store
│  │  │  └─ slices/
│  │  │     ├─ authSlice.ts                 # Auth state (currentUser, loaded), sign-in/up thunks (now superseded by AuthProvider but still present)
│  │  │     ├─ postSlice.ts                 # Create post, fetch posts by user
│  │  │     ├─ chatSlice.ts, modalSlice.ts  # Chat state and modal UI state
│  │  ├─ services/
│  │  │  ├─ user.ts                         # Profile image upload, field updates, follow/unfollow, user queries (Supabase)
│  │  │  ├─ chat.ts                         # Chat/message CRUD via Supabase
│  │  │  ├─ utils.ts                        # Media upload helper (Supabase storage)
│  │  ├─ components/
│  │  │  ├─ auth/                           # Auth UI (menu/details forms using Redux thunks)
│  │  │  ├─ chat/, general/, modal/, profile/, search/  # UI components for features
│  │  ├─ screens/
│  │  │  ├─ auth/                           # Auth screen toggling menu/details
│  │  │  ├─ feed/, search/, chat/, profile/, savePost/, camera/ # Feature screens
│  │  ├─ styles/                            # Shared styles
│  │  └─ navigation assets                  # (as above)
│  ├─ types/index.ts                        # Shared TS types (User/Post/Chat/Message)
│  ├─ app.json, babel.config.js, metro.config.js # Expo configs
│  ├─ package.json / package-lock.json      # Expo project deps (includes @react-native-async-storage/async-storage, supabase-js, RN nav); react-query v5
│  └─ .env.example                          # EXPO_PUBLIC_SUPABASE_URL / ANON_KEY / STORAGE_BUCKET
├─ change-log/                              # This log folder
└─ README.md                                # Project overview (Supabase migration noted)
```

## Supabase/Auth Details
- Env vars (Expo):
  - `EXPO_PUBLIC_SUPABASE_URL`
  - `EXPO_PUBLIC_SUPABASE_ANON_KEY`
  - `EXPO_PUBLIC_SUPABASE_STORAGE_BUCKET` (defaults to `media`)
  - Optional: `EXPO_PUBLIC_SUPABASE_FUNCTION_URL` if calling Edge Functions directly
- Client: `supabaseClient.ts` with AsyncStorage storage, persist/auto-refresh enabled, URL detection disabled for native.
- Auth lifecycle: `AuthProvider` fetches session, ensures `user` row exists, subscribes to realtime updates, hydrates Redux auth + preloads posts; provides `signIn`, `signUp`, `signOut`, `refreshProfile` via `useAuth`.
- Legacy Redux auth thunks largely removed from UI; prefer `useAuth` API.
- Profile schema: `user` table fields used: `uid`, `email`, `displayName`, `photoURL`, `followingCount`, `followersCount`, `likesCount`.

## Mux Integration (new)
- Schema: `public.post` now has `media_type`, `mux_playback_id`, `mux_asset_id`, `poster_url`.
- Edge Functions (Supabase):
  - `mux-create-upload`: returns Mux direct upload URL/id (secrets: `MUX_TOKEN_ID`, `MUX_TOKEN_SECRET`).
  - `mux-webhook`: handles Mux webhook `video.asset.ready`, updates post with playback/asset ids (secrets: `PROJECT_SUPABASE_URL`, `PROJECT_SUPABASE_SERVICE_ROLE_KEY`).
- Webhook URL: `https://<project-ref>.functions.supabase.co/mux-webhook` (registered in Mux dashboard).
- Playback: use `https://stream.mux.com/{mux_playback_id}.m3u8` in feed player.

## Data/Scraper Details
- `backend/Supabase/schema.sql`: defines Supabase tables (user, post, following, chat, message, etc.).
- Scraper workflow:
  1) `cd backend/Supabase`
  2) Ensure env vars for Supabase URL/anon key and Playwright deps installed (`npm install`).
  3) Run `node scrape_all_to_supabase.mjs` to scrape `collegecoaches-all` and upsert to Supabase (conflict target set to unique coach key). Logs write to `logs/scrape_<timestamp>.log`.
- Last noted run (per prior context): succeeded after unique constraint alignment.

## Frontend Run Book
- Prereqs: Node 18+, Expo CLI, iOS/Android simulators or Expo Go.
- Setup: `cd frontend && npm install` (already includes AsyncStorage + supabase-js).
- Env: create `.env` with Supabase URL/anon/storage bucket (and optional functions URL).
- Start (recommended): `npx expo start --go --port 8082 -c` for Expo Go (or `--dev-client` if using a custom client). Defaults also work: `npm run start`.
- Auth flow: Email/password; session persisted via AsyncStorage. Profiles auto-created on first sign-up. Home screens rely on `auth.currentUser` from Redux (populated by AuthProvider realtime subscription).
- Media upload: `services/utils.ts` + Supabase storage; posts store media URLs in `post.media` array. Mux HLS supported when `mux_playback_id` is present.

## Backend/Scraper Run Book
- `cd backend/Supabase && npm install` (already done; package-lock present).
- Ensure Supabase env (URL, anon/service key as needed) via `.env` or shell vars.
- Run scraper: `node scrape_all_to_supabase.mjs` (outputs to logs dir).
- Schema: apply `schema.sql` to Supabase project before running app/scraper.

- Navigation: `Route` stack gates on auth; `Home` is tabbed (Feed/Search/Add/Inbox/Me). Feed has top-tab for profile view.
- Realtime: AuthProvider subscribes to `user` table row changes; chat hooks use Supabase channels (see `useChats`/`useMessages`).
- Storage: Uses Supabase storage bucket `media` (configurable via env). Mux HLS playback supported when `mux_playback_id` exists.
- React Query upgraded to v5 object syntax (`useQuery`, `useMutation`, `useFollowing*`, `useUser`).
- Camera screen guarded against undefined `CameraType` (fallback defaults to avoid runtime crash).
- Vulnerabilities: previous scan reported 30 (8 low, 7 moderate, 14 high, 1 critical). Consider `npm audit fix` when safe.

## What to Do Next (if continuing)
1) Migrate auth UI to use `useAuth` instead of Redux thunks (keeps single source of truth).
2) Add error/loading UX for auth and profile hydration.
3) Confirm Supabase schema deployed (including mux fields) and bucket `media` with RLS in place.
4) Deploy/keep Supabase Edge Functions updated (`mux-create-upload`, `mux-webhook`); secrets set with non-`SUPABASE_` prefixes.
5) Re-run scraper when source data updates; monitor logs in `backend/Supabase/logs/`.
6) Consider renaming bundle ids/package to Tayp if keeping that branding; requires new dev/prod builds.

## Minimal Recreation Steps (Fresh Machine)
1) Clone repo; set up Supabase project and apply `backend/Supabase/schema.sql`.
2) Create storage bucket `media` (or set `EXPO_PUBLIC_SUPABASE_STORAGE_BUCKET`).
3) Set env vars in `frontend/.env` and backend as needed.
4) Install deps: `cd frontend && npm install`; `cd backend/Supabase && npm install`.
5) Run frontend: `npm run start` (Expo). Sign up with email/password; profile row is auto-created.
6) Optional: run scraper to populate coaches: `cd backend/Supabase && node scrape_all_to_supabase.mjs`.

## Reference: Key Files and Responsibilities
- `frontend/App.tsx`: Root providers (Redux, React Query, AuthProvider) + navigation entry.
- `frontend/supabaseClient.ts`: Supabase client config for native.
- `frontend/src/providers/AuthProvider.tsx`: Auth/session/profile lifecycle, realtime subscription, Redux sync.
- `frontend/src/navigation/main/index.tsx`: Auth gate + stack routes.
- `frontend/src/navigation/home/index.tsx`: Bottom tabs.
- `frontend/src/navigation/feed/index.tsx`: Feed/profile top tabs.
- `frontend/src/redux/slices/authSlice.ts`: Legacy auth thunks and state.
- `frontend/src/redux/slices/postSlice.ts`: Post CRUD (create, fetch by user).
- `frontend/src/services/user.ts`: Profile updates, follow logic, user queries.
- `frontend/src/services/chat.ts`: Chat/message operations.
- `backend/Supabase/schema.sql`: DB schema.
- `backend/Supabase/scrape_all_to_supabase.mjs`: Scraper orchestrator.
```
